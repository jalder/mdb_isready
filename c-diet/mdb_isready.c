#include <stdio.h>
#include <unistd.h>
#include <netdb.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
//#include <bson/bson.h>
#include <sys/socket.h>
#include <stdint.h>
#include <string.h>

#define PORT 27017

int 
main(int argc, char *argv[])
{
	int sockfd;
	struct sockaddr_in servaddr;
	//const char *message_b64 = "YAEAAAIAAAAAAAAA1AcAAAQAAABhZG1pbi4kY21kAAAAAAD/////OQEAABBpc01hc3RlcgABAAAACGhlbGxvT2sAAQNjbGllbnQAAgEAAANhcHBsaWNhdGlvbgAbAAAAAm5hbWUADAAAAG1kYl9pc3JlYWR5AAADZHJpdmVyACoAAAACbmFtZQAHAAAAbW9uZ29jAAJ2ZXJzaW9uAAcAAAAxLjIzLjEAAANvcwBZAAAAAnR5cGUABgAAAExpbnV4AAJuYW1lABEAAABEZWJpYW4gR05VL0xpbnV4AAJ2ZXJzaW9uAAMAAAAxMgACYXJjaGl0ZWN0dXJlAAcAAAB4ODZfNjQAAAJwbGF0Zm9ybQA4AAAAY2ZnPTB4MDNhMTVlODhlOSBwb3NpeD0yMDA4MDkgc3RkYz0yMDE3MTAgQ0M9R0NDIDEyLjIuMAAABGNvbXByZXNzaW9uAAUAAAAAAA==";
	//unsigned char hello[] = {0x60, 0x1, 0x0, 0x0, 0x2, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xd4, 0x7, 0x0, 0x0, 0x4, 0x0, 0x0, 0x0, 0x61, 0x64, 0x6d, 0x69, 0x6e, 0x2e, 0x24, 0x63, 0x6d, 0x64, 0x0, 0x0, 0x0, 0x0, 0x0, 0xff, 0xff, 0xff, 0xff, 0x39, 0x1, 0x0, 0x0, 0x10, 0x69, 0x73, 0x4d, 0x61, 0x73, 0x74, 0x65, 0x72, 0x0, 0x1, 0x0, 0x0, 0x0, 0x8, 0x68, 0x65, 0x6c, 0x6c, 0x6f, 0x4f, 0x6b, 0x0, 0x1, 0x3, 0x63, 0x6c, 0x69, 0x65, 0x6e, 0x74, 0x0, 0x2, 0x1, 0x0, 0x0, 0x3, 0x61, 0x70, 0x70, 0x6c, 0x69, 0x63, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x0, 0x1b, 0x0, 0x0, 0x0, 0x2, 0x6e, 0x61, 0x6d, 0x65, 0x0, 0xc, 0x0, 0x0, 0x0, 0x6d, 0x64, 0x62, 0x5f, 0x69, 0x73, 0x72, 0x65, 0x61, 0x64, 0x79, 0x0, 0x0, 0x3, 0x64, 0x72, 0x69, 0x76, 0x65, 0x72, 0x0, 0x2a, 0x0, 0x0, 0x0, 0x2, 0x6e, 0x61, 0x6d, 0x65, 0x0, 0x7, 0x0, 0x0, 0x0, 0x6d, 0x6f, 0x6e, 0x67, 0x6f, 0x63, 0x0, 0x2, 0x76, 0x65, 0x72, 0x73, 0x69, 0x6f, 0x6e, 0x0, 0x7, 0x0, 0x0, 0x0, 0x31, 0x2e, 0x32, 0x33, 0x2e, 0x31, 0x0, 0x0, 0x3, 0x6f, 0x73, 0x0, 0x59, 0x0, 0x0, 0x0, 0x2, 0x74, 0x79, 0x70, 0x65, 0x0, 0x6, 0x0, 0x0, 0x0, 0x4c, 0x69, 0x6e, 0x75, 0x78, 0x0, 0x2, 0x6e, 0x61, 0x6d, 0x65, 0x0, 0x11, 0x0, 0x0, 0x0, 0x44, 0x65, 0x62, 0x69, 0x61, 0x6e, 0x20, 0x47, 0x4e, 0x55, 0x2f, 0x4c, 0x69, 0x6e, 0x75, 0x78, 0x0, 0x2, 0x76, 0x65, 0x72, 0x73, 0x69, 0x6f, 0x6e, 0x0, 0x3, 0x0, 0x0, 0x0, 0x31, 0x32, 0x0, 0x2, 0x61, 0x72, 0x63, 0x68, 0x69, 0x74, 0x65, 0x63, 0x74, 0x75, 0x72, 0x65, 0x0, 0x7, 0x0, 0x0, 0x0, 0x78, 0x38, 0x36, 0x5f, 0x36, 0x34, 0x0, 0x0, 0x2, 0x70, 0x6c, 0x61, 0x74, 0x66, 0x6f, 0x72, 0x6d, 0x0, 0x38, 0x0, 0x0, 0x0, 0x63, 0x66, 0x67, 0x3d, 0x30, 0x78, 0x30, 0x33, 0x61, 0x31, 0x35, 0x65, 0x38, 0x38, 0x65, 0x39, 0x20, 0x70, 0x6f, 0x73, 0x69, 0x78, 0x3d, 0x32, 0x30, 0x30, 0x38, 0x30, 0x39, 0x20, 0x73, 0x74, 0x64, 0x63, 0x3d, 0x32, 0x30, 0x31, 0x37, 0x31, 0x30, 0x20, 0x43, 0x43, 0x3d, 0x47, 0x43, 0x43, 0x20, 0x31, 0x32, 0x2e, 0x32, 0x2e, 0x30, 0x0, 0x0, 0x4, 0x63, 0x6f, 0x6d, 0x70, 0x72, 0x65, 0x73, 0x73, 0x69, 0x6f, 0x6e, 0x0, 0x5, 0x0, 0x0, 0x0, 0x0, 0x0};
	// socket create and varification
	sockfd = socket(AF_INET, SOCK_STREAM, 0);
	if (sockfd == -1) {
		printf("socket creation failed...\n");
		exit(0);
	}
	struct hostent *server;
	server = gethostbyname(argv[1]);

	if (server == NULL) {
    		// Handle error: host not found
    		fprintf(stderr,"ERROR, no such host\n");
    		exit(0);
	}

	bzero(&servaddr, sizeof(servaddr));
	servaddr.sin_family = AF_INET;
	memcpy(&servaddr.sin_addr.s_addr, server->h_addr_list[0], server->h_length);
	int port = atoi(argv[2]);
	servaddr.sin_port = htons(port);


	struct MsgHeader {
    		int32_t   messageLength; // total message size, including this
    		int32_t   requestID;     // identifier for this message
    		int32_t   responseTo;    // requestID from the original request
                           //   (used in responses from the database)
    		int32_t   opCode;        // message type
	};
	struct OpReply{
    		int32_t     responseFlags;  // bit values - see details below
    		int64_t     cursorID;       // cursor ID if client needs to do get more's
    		int32_t     startingFrom;   // where in the cursor this reply is starting
    		int32_t     numberReturned; // number of documents in the reply
    		char documents[];      // documents
	};
	struct Element{
                char type;  //bson type
                char name[]; //field name
        };
	struct Doc{
		int32_t  length; //total size of doc, including null terminator
		struct Element elements[]; //list of elements in doc
	};

	struct MsgHeader hello_header;
	hello_header.messageLength = 352; //16 for the header, plus add message length
	hello_header.requestID = 13;
	hello_header.responseTo = 0;
	hello_header.opCode = 2004;
	
	struct OpQuery {
		struct MsgHeader header;
		int32_t query_flags; 
		unsigned char fullCollectionName[11];    
    		int32_t numberToSkip;             
    		int32_t numberToReturn;
		unsigned char query[313];  //352-16-4-11-4-4= 313
	};
	struct OpQuery hello_query;
	hello_query.header = hello_header;
	hello_query.query_flags = 4;
	unsigned char collectionName[11] = {0x61, 0x64, 0x6d, 0x69, 0x6e, 0x2e, 0x24, 0x63, 0x6d, 0x64, 0x0};
	memcpy(hello_query.fullCollectionName, collectionName, 11);	
	hello_query.numberToSkip = 0;
	hello_query.numberToReturn = -1;
	unsigned char query[313] = {0x39, 0x1, 0x0, 0x0, 0x10, 0x69, 0x73, 0x4d, 0x61, 0x73, 0x74, 0x65, 0x72, 0x0, 0x1, 0x0, 0x0, 0x0, 0x8, 0x68, 0x65, 0x6c, 0x6c, 0x6f, 0x4f, 0x6b, 0x0, 0x1, 0x3, 0x63, 0x6c, 0x69, 0x65, 0x6e, 0x74, 0x0, 0x2, 0x1, 0x0, 0x0, 0x3, 0x61, 0x70, 0x70, 0x6c, 0x69, 0x63, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x0, 0x1b, 0x0, 0x0, 0x0, 0x2, 0x6e, 0x61, 0x6d, 0x65, 0x0, 0xc, 0x0, 0x0, 0x0, 0x6d, 0x64, 0x62, 0x5f, 0x69, 0x73, 0x72, 0x65, 0x61, 0x64, 0x79, 0x0, 0x0, 0x3, 0x64, 0x72, 0x69, 0x76, 0x65, 0x72, 0x0, 0x2a, 0x0, 0x0, 0x0, 0x2, 0x6e, 0x61, 0x6d, 0x65, 0x0, 0x7, 0x0, 0x0, 0x0, 0x6d, 0x6f, 0x6e, 0x67, 0x6f, 0x63, 0x0, 0x2, 0x76, 0x65, 0x72, 0x73, 0x69, 0x6f, 0x6e, 0x0, 0x7, 0x0, 0x0, 0x0, 0x31, 0x2e, 0x32, 0x33, 0x2e, 0x31, 0x0, 0x0, 0x3, 0x6f, 0x73, 0x0, 0x59, 0x0, 0x0, 0x0, 0x2, 0x74, 0x79, 0x70, 0x65, 0x0, 0x6, 0x0, 0x0, 0x0, 0x4c, 0x69, 0x6e, 0x75, 0x78, 0x0, 0x2, 0x6e, 0x61, 0x6d, 0x65, 0x0, 0x11, 0x0, 0x0, 0x0, 0x44, 0x65, 0x62, 0x69, 0x61, 0x6e, 0x20, 0x47, 0x4e, 0x55, 0x2f, 0x4c, 0x69, 0x6e, 0x75, 0x78, 0x0, 0x2, 0x76, 0x65, 0x72, 0x73, 0x69, 0x6f, 0x6e, 0x0, 0x3, 0x0, 0x0, 0x0, 0x31, 0x32, 0x0, 0x2, 0x61, 0x72, 0x63, 0x68, 0x69, 0x74, 0x65, 0x63, 0x74, 0x75, 0x72, 0x65, 0x0, 0x7, 0x0, 0x0, 0x0, 0x78, 0x38, 0x36, 0x5f, 0x36, 0x34, 0x0, 0x0, 0x2, 0x70, 0x6c, 0x61, 0x74, 0x66, 0x6f, 0x72, 0x6d, 0x0, 0x38, 0x0, 0x0, 0x0, 0x63, 0x66, 0x67, 0x3d, 0x30, 0x78, 0x30, 0x33, 0x61, 0x31, 0x35, 0x65, 0x38, 0x38, 0x65, 0x39, 0x20, 0x70, 0x6f, 0x73, 0x69, 0x78, 0x3d, 0x32, 0x30, 0x30, 0x38, 0x30, 0x39, 0x20, 0x73, 0x74, 0x64, 0x63, 0x3d, 0x32, 0x30, 0x31, 0x37, 0x31, 0x30, 0x20, 0x43, 0x43, 0x3d, 0x47, 0x43, 0x43, 0x20, 0x31, 0x32, 0x2e, 0x32, 0x2e, 0x30, 0x0, 0x0, 0x4, 0x63, 0x6f, 0x6d, 0x70, 0x72, 0x65, 0x73, 0x73, 0x69, 0x6f, 0x6e, 0x0, 0x5, 0x0, 0x0, 0x0, 0x0, 0x0};
	memcpy(hello_query.query, query, 313);
	
	// connect the client socket to server socket
	if (connect(sockfd, (struct sockaddr*)&servaddr, sizeof(servaddr)) != 0) {
		printf("connection with the server failed...\n");
		exit(0);
	} else{
		printf("connected to the server..\n");


		int total_sent = 0;
		int bytes_left = sizeof(hello_query);
		int n;

		while (total_sent < sizeof(hello_query)) {
    			n = send(sockfd, (const void*)&hello_query, bytes_left, 0);
    			if (n == -1) { 
        			// Handle error (check errno)
        			break; 
    			}
    			total_sent += n;
    			bytes_left -= n;
		}

		struct MsgHeader received_data;
		struct OpReply reply;
		ssize_t bytes_received;

		// Receive data into the struct
		bytes_received = recv(sockfd, &received_data, sizeof(received_data), 0);

		if (bytes_received == -1) {
		    // Handle error (e.g., check errno)
		    perror("recv failed");
		} else if (bytes_received == 0) {
		    // Connection closed by peer
		    printf("Connection closed\n");
		} else {
		    // Data received successfully, process received_data
		    printf("Received %zd bytes\n", bytes_received);
		    printf("Message Length: %d\n", received_data.messageLength);
		    printf("Request ID: %d\n", received_data.requestID);
		    printf("Response To: %d\n", received_data.responseTo);
		    printf("opCode: %d\n", received_data.opCode);
		}
		int message_cont_length = received_data.messageLength - 16;
		printf("Remaining message length: %d\n", message_cont_length);
		if(received_data.opCode == 1){
		    printf("Received OP_REPLY Legacy Response\n");
		    recv(sockfd, &reply, message_cont_length - 1, 0);
		}
		int document_length = message_cont_length - 20;
		printf("Response: \n%s\n", reply.documents);
		for (int i = 0; i < document_length - 1; i++) {
        		printf("%02X ", reply.documents[i]);
			if(reply.documents[i] == 'o'){
				if(reply.documents[i+1] == 'k'){
					printf("OKAY FOUND!\n");
					double okay;
					memcpy(&okay, &reply.documents[i+4], sizeof(double));
					printf("{ok:%d}", okay);
				}
			}
    		}
    		printf("\n");
	}

	close(sockfd);
}


